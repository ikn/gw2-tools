#! /usr/bin/env bash

base_url="http://www.deltaconnected.com/arcdps/x64/"
dll_name="d3d9.dll"
bt_dll_name="d3d9_arcdps_buildtemplates.dll"

install_dir="$1"
[ -z "$install_dir" ] && {
    echo >&2 "expected first argument: Guild Wars 2 installation directory"
    exit 2
}
[ -d "$install_dir" ] || {
    echo >&2 "no such directory: $install_dir"
    exit 2
}
install_dir="$install_dir/bin64"
[ -d "$install_dir" ] || {
    echo >&2 "no such directory: $install_dir"
    exit 2
}

tmp="$(mktemp -d)"
cd "$tmp"

wget --no-verbose \
    "$base_url/$dll_name" "$base_url/$dll_name.md5sum" \
    "$base_url/buildtemplates/$bt_dll_name" || exit 1
# md5sum file expects files to be in directory `x64`
mkdir x64 || exit 1
cp "$dll_name" "$bt_dll_name" x64 || exit 1
md5sum --quiet --check "$dll_name.md5sum" || exit 1
install -m644 "$dll_name" "$bt_dll_name" "$install_dir" || exit 1

rm -rf "$tmp"
