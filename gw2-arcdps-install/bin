#! /usr/bin/env bash

BASE_URL="http://www.deltaconnected.com/arcdps/x64/"
DLL_NAME="d3d9.dll"
BT_DLL_NAME="d3d9_arcdps_buildtemplates.dll"

INSTALL_PATH="$GW2_INSTALL_PATH"

[ -z "$INSTALL_PATH" ] && {
    if [ -n "$WINEPREFIX" ]; then
        INSTALL_PATH="$WINEPREFIX/drive_c/Program Files/Guild Wars 2"
    else
        echo >&2 "error: environment variable not set: GW2_INSTALL_PATH"
        exit 2
    fi
}
[ -d "$INSTALL_PATH" ] || {
    echo >&2 "error: not a directory: $INSTALL_PATH"
    exit 2
}
INSTALL_PATH="$INSTALL_PATH/bin64"
[ -d "$INSTALL_PATH" ] || {
    echo >&2 "no such directory: $INSTALL_PATH"
    exit 2
}
echo >&2 "info: installing to directory: $INSTALL_PATH"

tmp="$(mktemp -d)"
cd "$tmp"

wget --no-verbose \
    "$BASE_URL/$DLL_NAME" "$BASE_URL/$DLL_NAME.md5sum" \
    "$BASE_URL/buildtemplates/$BT_DLL_NAME" || exit 1
# md5sum file expects files to be in directory `x64`
mkdir x64 || exit 1
cp "$DLL_NAME" "$BT_DLL_NAME" x64 || exit 1
md5sum --quiet --check "$DLL_NAME.md5sum" || exit 1
install -m644 "$DLL_NAME" "$BT_DLL_NAME" "$INSTALL_PATH" || exit 1

rm -rf "$tmp"
